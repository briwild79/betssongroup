import React, { useState, useEffect, useRef } from 'react';
import { ChevronRight, Home, Calendar, Trophy, Users, User, Play, Pause, SkipForward, Mic, Search, Bell, X, Zap, Target, Gift } from 'lucide-react';

const FanZapMobile = () => {
  const [activeTab, setActiveTab] = useState('home');
  const [isPlaying, setIsPlaying] = useState(true);
  const [showBottomSheet, setShowBottomSheet] = useState(false);
  const [selectedMatch, setSelectedMatch] = useState(null);
  const [showMissions, setShowMissions] = useState(false);
  const [coins, setCoins] = useState(1230);
  const [xp, setXp] = useState(340);
  const [level, setLevel] = useState(6);
  const [passes, setPasses] = useState(2);
  const [tipLotteryPool, setTipLotteryPool] = useState(2485);
  const [showXpPopup, setShowXpPopup] = useState(false);
  const [xpGained, setXpGained] = useState(0);

  // Mock data
  const liveMatches = [
    { id: 1, home: 'MU', away: 'LIV', time: '67', commentators: 24, listeners: 3200, trending: true, premium: true, lotteryActive: true },
    { id: 2, home: 'CHE', away: 'ARS', time: '45', commentators: 18, listeners: 2100, fanzapOff: true },
    { id: 3, home: 'MC', away: 'TOT', time: '23', commentators: 15, listeners: 1800 }
  ];

  const featuredCommentators = [
    { id: 1, name: 'JamieCarra', initials: 'JC', match: 'MU vs LIV', rating: 5, status: 'LIVE', followers: '12.5k' },
    { id: 2, name: 'TheHammer', initials: 'TH', match: 'CHE vs ARS', rating: 4, status: 'LIVE', followers: '8.2k' },
    { id: 3, name: 'FootyBanter', initials: 'FB', match: 'Coming: BAR vs RMA', rating: 5, status: 'SOON', followers: '15.1k' }
  ];

  const missions = [
    { id: 1, title: 'Join 2 commentary rooms', progress: 1, max: 2, reward: '50 XP', completed: false },
    { id: 2, title: 'Tip a new commentator', progress: 0, max: 1, reward: '10 Coins', completed: false },
    { id: 3, title: 'Win a crew prediction', progress: 0, max: 1, reward: 'Mystery Box', completed: false, locked: true }
  ];

  const crews = [
    { id: 1, name: 'Red Devils Unite', members: ['A', 'B', 'C', '+5'], status: 'Live Now', active: true, streak: 6 },
    { id: 2, name: 'Chelsea Massive', members: ['D', 'E', 'F'], status: 'Join Countdown', active: false, wins: 10 }
  ];

  // Simulate XP gain
  const gainXP = (amount) => {
    setXpGained(amount);
    setShowXpPopup(true);
    setXp(prev => prev + amount);
    setTimeout(() => setShowXpPopup(false), 2000);
    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
  };

  // Handle tip action
  const handleTip = () => {
    if (coins >= 50) {
      setCoins(prev => prev - 50);
      gainXP(25);
      setTipLotteryPool(prev => prev + 50);
    }
  };

  // Simulate lottery pool growth
  useEffect(() => {
    const interval = setInterval(() => {
      setTipLotteryPool(prev => prev + Math.floor(Math.random() * 10));
    }, 5000);
    return () => clearInterval(interval);
  }, []);

  const handleMatchClick = (match) => {
    setSelectedMatch(match);
    setShowBottomSheet(true);
    if (navigator.vibrate) navigator.vibrate(50);
  };

  // XP Popup Component
  const XPPopup = () => (
    <div className={`fixed top-20 right-4 transition-all duration-500 z-50 ${showXpPopup ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-4'}`}>
      <div className="bg-yellow-400 text-black px-4 py-2 rounded-full font-bold text-sm shadow-lg">
        +{xpGained} XP ⚡
      </div>
    </div>
  );

  // Missions Modal
  const MissionsModal = () => (
    <div className={`fixed inset-0 z-50 ${showMissions ? 'pointer-events-auto' : 'pointer-events-none'}`}>
      <div 
        className={`absolute inset-0 bg-black transition-opacity duration-300 ${showMissions ? 'opacity-50' : 'opacity-0'}`}
        onClick={() => setShowMissions(false)}
      />
      <div className={`absolute bottom-0 left-0 right-0 bg-gray-900 rounded-t-3xl transform transition-transform duration-300 ${showMissions ? 'translate-y-0' : 'translate-y-full'} max-h-[80vh] overflow-y-auto`}>
        <div className="w-12 h-1 bg-gray-600 rounded-full mx-auto mt-3 mb-4" />
        <div className="px-6 pb-8">
          <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
            <span className="text-2xl">🎯</span> Daily Missions
          </h3>
          <div className="space-y-3">
            {missions.map((mission) => (
              <div key={mission.id} className={`bg-gray-800 rounded-2xl p-4 ${mission.locked ? 'opacity-50' : ''}`}>
                <div className="flex items-center justify-between mb-2">
                  <div className="font-semibold">{mission.title}</div>
                  {mission.locked && <span className="text-xs">🔒</span>}
                </div>
                <div className="bg-gray-700 rounded-full h-2 mb-2 overflow-hidden">
                  <div 
                    className="bg-gradient-to-r from-green-400 to-green-600 h-full transition-all duration-500"
                    style={{ width: `${(mission.progress / mission.max) * 100}%` }}
                  />
                </div>
                <div className="text-xs text-yellow-400">Reward: {mission.reward}</div>
              </div>
            ))}
          </div>
          <button className="w-full mt-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-2xl">
            🎁 Open Mystery Box (3 missions needed)
          </button>
        </div>
      </div>
    </div>
  );

  const BottomSheet = () => (
    <div className={`fixed inset-0 z-50 ${showBottomSheet ? 'pointer-events-auto' : 'pointer-events-none'}`}>
      <div 
        className={`absolute inset-0 bg-black transition-opacity duration-300 ${showBottomSheet ? 'opacity-50' : 'opacity-0'}`}
        onClick={() => setShowBottomSheet(false)}
      />
      <div className={`absolute bottom-0 left-0 right-0 bg-gray-900 rounded-t-3xl transform transition-transform duration-300 ${showBottomSheet ? 'translate-y-0' : 'translate-y-full'}`}>
        <div className="w-12 h-1 bg-gray-600 rounded-full mx-auto mt-3 mb-4" />
        {selectedMatch?.fanzapOff && (
          <div className="mx-6 mb-4 bg-gradient-to-r from-red-500 to-blue-500 rounded-2xl p-4 text-center">
            <div className="text-xs mb-1">⚔️ FANZAP OFF ⚔️</div>
            <div className="font-bold">Chelsea Fans vs Arsenal Fans</div>
            <div className="text-sm mt-2">🔥 Join the Battle!</div>
          </div>
        )}
        <div className="px-6 pb-8">
          <h3 className="text-xl font-bold mb-4">Join Match Commentary</h3>
          <div className="space-y-3">
            <button 
              onClick={() => {
                gainXP(10);
                setShowBottomSheet(false);
              }}
              className="w-full bg-green-500 text-black font-bold py-4 rounded-2xl flex items-center justify-center gap-2"
            >
              <Mic className="w-5 h-5" />
              Quick Join Audio
            </button>
            <button className="w-full bg-gray-800 text-white font-bold py-4 rounded-2xl">
              Browse All Commentators
            </button>
            <button className="w-full bg-gray-800 text-white font-bold py-4 rounded-2xl">
              Join with Crew
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  const HomeContent = () => (
    <div className="pb-40 overflow-y-auto h-full">
      {/* Live Matches */}
      <section className="px-4 pt-3 mb-6">
        <h2 className="text-lg font-bold mb-3 flex items-center gap-2">
          <span className="text-2xl">🔥</span> Live Matches
        </h2>
        <div className="flex gap-3 overflow-x-auto scrollbar-hide pb-2">
          {liveMatches.map((match) => (
            <div
              key={match.id}
              onClick={() => handleMatchClick(match)}
              className="relative min-w-[280px] bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-4 border border-gray-700 active:scale-95 transition-transform"
            >
              {match.trending && (
                <div className="absolute -top-2 -right-2 bg-orange-500 text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1">
                  🔥 Trending
                </div>
              )}
              {match.lotteryActive && (
                <div className="absolute top-2 left-2 right-2 bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-500/50 rounded-lg p-2">
                  <div className="text-xs font-bold text-yellow-300 text-center">
                    🎰 Tip Pool: £{tipLotteryPool}
                  </div>
                  <div className="text-xs text-gray-300 text-center">5 fans win at FT</div>
                </div>
              )}
              <div className={`flex items-center justify-between mb-3 ${match.lotteryActive ? 'mt-14' : ''}`}>
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center font-bold text-sm">
                    {match.home}
                  </div>
                  <span className="text-gray-500 font-semibold">vs</span>
                  <div className="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center font-bold text-sm">
                    {match.away}
                  </div>
                </div>
                <div className="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-lg">
                  LIVE {match.time}'
                </div>
              </div>
              <div className="flex gap-4 text-sm text-gray-400">
                <span>🎙️ {match.commentators}</span>
                <span>👂 {(match.listeners / 1000).toFixed(1)}k</span>
                {match.premium && <span>⭐ Premium</span>}
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* Featured Commentators */}
      <section className="px-4 mb-6">
        <h2 className="text-lg font-bold mb-3 flex items-center gap-2">
          <span className="text-2xl">🎙️</span> Featured Commentators
        </h2>
        <div className="space-y-3">
          {featuredCommentators.map((comm) => (
            <div key={comm.id} className="bg-gray-800 rounded-2xl p-4 flex items-center gap-4 active:scale-98 transition-transform">
              <div className="w-14 h-14 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center font-bold text-black">
                {comm.initials}
              </div>
              <div className="flex-1">
                <div className="font-semibold">{comm.name}</div>
                <div className="text-sm text-gray-400">{comm.match}</div>
                <div className="flex items-center gap-2 mt-1">
                  <span className="text-yellow-400">{'⭐'.repeat(comm.rating)}</span>
                  <span className="text-xs text-gray-500">{comm.followers}</span>
                </div>
              </div>
              <div className="text-right">
                {comm.status === 'LIVE' && (
                  <div className="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-2">
                    LIVE
                  </div>
                )}
                <button 
                  onClick={(e) => {
                    e.stopPropagation();
                    gainXP(5);
                  }}
                  className="bg-green-500 text-black text-sm font-bold px-4 py-2 rounded-full active:scale-95 transition-transform"
                >
                  Follow
                </button>
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* Crew Leaderboards */}
      <section className="px-4 mb-6">
        <h2 className="text-lg font-bold mb-3 flex items-center gap-2">
          <span className="text-2xl">🏆</span> Top Crews This Week
        </h2>
        <div className="bg-gradient-to-br from-yellow-900/20 to-orange-900/20 rounded-2xl p-4 border border-yellow-800/30 mb-3">
          <div className="text-center mb-2">
            <div className="text-3xl mb-1">🥇</div>
            <div className="font-bold">Liverpool Legion</div>
            <div className="text-sm text-gray-400">12,450 XP • 89 Members</div>
          </div>
        </div>
        <div className="space-y-3">
          {crews.map((crew, idx) => (
            <div key={crew.id} className="bg-gradient-to-br from-purple-900/20 to-blue-900/20 rounded-2xl p-4 border border-purple-800/30">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-3">
                  <div className="text-2xl">{idx === 0 ? '🥈' : '🥉'}</div>
                  <div>
                    <div className="font-semibold">{crew.name}</div>
                    {crew.streak && <div className="text-xs text-orange-400">🔥 {crew.streak} Day Streak</div>}
                    {crew.wins && <div className="text-xs text-green-400">🎯 {crew.wins} Wins</div>}
                  </div>
                </div>
                <span className={`text-xs font-bold px-3 py-1 rounded-full ${crew.active ? 'bg-green-500 text-black' : 'bg-gray-700'}`}>
                  {crew.status}
                </span>
              </div>
              <div className="flex -space-x-2 mb-3">
                {crew.members.map((member, idx) => (
                  <div key={idx} className="w-8 h-8 bg-gray-700 rounded-full border-2 border-gray-900 flex items-center justify-center text-xs font-bold">
                    {member}
                  </div>
                ))}
              </div>
              <button className="w-full bg-gray-800 text-white text-sm font-medium py-2 rounded-xl active:scale-95 transition-transform">
                Join Battle
              </button>
            </div>
          ))}
        </div>
      </section>

      {/* Mystery Box CTA */}
      <section className="px-4 mb-6">
        <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 text-center">
          <div className="text-4xl mb-2">🎁</div>
          <div className="font-bold text-lg mb-1">Mystery Box Available!</div>
          <div className="text-sm mb-3">Complete 3 missions to unlock</div>
          <button 
            onClick={() => setShowMissions(true)}
            className="bg-white text-purple-600 font-bold px-6 py-2 rounded-full"
          >
            View Missions
          </button>
        </div>
      </section>

      {/* Fan Discovery & Global Feed */}
      <section className="px-4 mb-6">
        <h2 className="text-lg font-bold mb-3 flex items-center gap-2">
          <span className="text-2xl">💡</span> Fan Discovery
        </h2>
        
        {/* Discovery Tabs */}
        <div className="flex gap-2 overflow-x-auto scrollbar-hide mb-4 pb-2">
          {[
            { id: 'worldwide', label: '🌍 Worldwide', active: true },
            { id: 'uk', label: '🇬🇧 UK Trending' },
            { id: 'rivals', label: '🔄 Rivals Face-Off' },
            { id: 'new', label: '🆕 New Voices' }
          ].map((tab) => (
            <button
              key={tab.id}
              className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all ${
                tab.active 
                  ? 'bg-green-500 text-black' 
                  : 'bg-gray-800 text-gray-300 border border-gray-700'
              }`}
            >
              {tab.label}
            </button>
          ))}
        </div>

        {/* Discovery Tiles */}
        <div className="space-y-3">
          {[
            { id: 1, name: 'KingFan92', initials: 'KF', listeners: 892, match: 'MU vs LIV' },
            { id: 2, name: 'LondonSpurs', initials: 'LS', listeners: 1243, match: 'TOT vs CHE' },
            { id: 3, name: 'RedArmyVoice', initials: 'RA', listeners: 2104, match: 'LIV vs MC' },
            { id: 4, name: 'BlueMoonRising', initials: 'BM', listeners: 567, match: 'MC vs ARS' }
          ].map((room) => (
            <div key={room.id} className="bg-gray-800 rounded-2xl p-4 flex items-center gap-3">
              <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold text-sm">
                {room.initials}
              </div>
              
              {/* Waveform Visualization */}
              <div className="flex-1 mx-3">
                <div className="flex items-end gap-0.5 h-10">
                  {[...Array(20)].map((_, i) => (
                    <div
                      key={i}
                      className="flex-1 bg-green-400 rounded-full opacity-60"
                      style={{
                        height: `${Math.random() * 100}%`,
                        minHeight: '4px'
                      }}
                    />
                  ))}
                </div>
                <div className="text-xs text-gray-500 mt-1">{room.match}</div>
              </div>
              
              <div className="text-right">
                <div className="text-sm text-gray-400 mb-2 flex items-center gap-1">
                  <span>👂</span>
                  <span>{room.listeners > 1000 ? `${(room.listeners / 1000).toFixed(1)}k` : room.listeners}</span>
                </div>
                {room.listeners > 1000 ? (
                  <button 
                    onClick={handleTip}
                    className="bg-red-500 text-white text-xs font-bold px-4 py-2 rounded-full active:scale-95 transition-transform"
                  >
                    💰 Tip
                  </button>
                ) : (
                  <button className="bg-gray-700 text-white text-xs font-bold px-4 py-2 rounded-full active:scale-95 transition-transform">
                    Join Crew
                  </button>
                )}
              </div>
            </div>
          ))}
        </div>
      </section>
    </div>
  );

  return (
    <div className="h-screen bg-black text-white flex flex-col" style={{ fontFamily: '"Press Start 2P", monospace' }}>
      {/* HUD-Style Header */}
      <header className="bg-gray-900 px-4 py-3 border-b-2 border-green-400 flex-shrink-0">
        <div className="flex items-center justify-between mb-2">
          <div className="text-xl font-black text-green-400" style={{ textShadow: '2px 2px 0 #ff0066', letterSpacing: '2px' }}>
            FANZAP
          </div>
          <div className="flex items-center gap-3">
            <Search className="w-5 h-5" />
            <Bell className="w-5 h-5" />
          </div>
        </div>
        
        {/* Game Stats Bar */}
        <div className="flex items-center justify-between text-xs">
          <div className="flex items-center gap-4">
            <button className="flex items-center gap-1 active:scale-95 transition-transform">
              <span className="text-yellow-400">🪙</span>
              <span className="font-bold">{coins}</span>
            </button>
            <div className="flex items-center gap-1">
              <span>🎫</span>
              <span className="font-bold">x{passes}</span>
            </div>
            <div className="flex items-center gap-1">
              <span className="text-purple-400">LV</span>
              <span className="font-bold">{level}</span>
              <div className="w-16 h-2 bg-gray-700 rounded-full overflow-hidden ml-1">
                <div 
                  className="h-full bg-gradient-to-r from-purple-400 to-pink-400"
                  style={{ width: `${(xp % 100) / 100 * 100}%` }}
                />
              </div>
            </div>
          </div>
          <button 
            onClick={() => setShowMissions(true)}
            className="bg-yellow-500 text-black px-3 py-1 rounded-full font-bold flex items-center gap-1 animate-pulse"
          >
            <Target className="w-3 h-3" />
            Missions
          </button>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="flex-1 overflow-hidden relative">
        {activeTab === 'home' && <HomeContent />}
        {activeTab === 'schedule' && (
          <div className="h-full flex items-center justify-center text-gray-500">
            <Calendar className="w-16 h-16" />
          </div>
        )}
        {activeTab === 'leagues' && (
          <div className="h-full flex items-center justify-center text-gray-500">
            <Trophy className="w-16 h-16" />
          </div>
        )}
        {activeTab === 'crews' && (
          <div className="h-full flex items-center justify-center text-gray-500">
            <Users className="w-16 h-16" />
          </div>
        )}
        {activeTab === 'profile' && (
          <div className="h-full flex items-center justify-center text-gray-500">
            <User className="w-16 h-16" />
          </div>
        )}
      </main>

      {/* Audio Player - Fixed above bottom nav */}
      <div className="bg-gray-900 border-t-2 border-green-400 px-4 py-3 flex-shrink-0">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-black font-bold">
              JC
            </div>
            <div>
              <div className="font-semibold text-sm">JamieCarra</div>
              <div className="text-xs text-gray-400">MU vs LIV • 67'</div>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <button onClick={() => setIsPlaying(!isPlaying)} className="active:scale-95 transition-transform">
              {isPlaying ? <Pause className="w-6 h-6" /> : <Play className="w-6 h-6" />}
            </button>
            <SkipForward className="w-5 h-5" />
            <button 
              onClick={handleTip}
              className="bg-red-500 text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-1 active:scale-95 transition-transform"
            >
              💰 Tip
            </button>
          </div>
        </div>
      </div>

      {/* Bottom Navigation */}
      <nav className="bg-gray-900 border-t border-gray-800 flex-shrink-0">
        <div className="flex justify-around py-2">
          {[
            { id: 'home', icon: Home, label: 'Home' },
            { id: 'schedule', icon: Calendar, label: 'Schedule' },
            { id: 'leagues', icon: Trophy, label: 'Leagues' },
            { id: 'crews', icon: Users, label: 'Crews' },
            { id: 'profile', icon: User, label: 'Profile' }
          ].map(({ id, icon: Icon, label }) => (
            <button
              key={id}
              onClick={() => {
                setActiveTab(id);
                if (navigator.vibrate) navigator.vibrate(20);
              }}
              className={`flex flex-col items-center gap-1 py-2 px-3 rounded-lg transition-all ${
                activeTab === id ? 'text-green-400' : 'text-gray-500'
              }`}
            >
              <Icon className="w-6 h-6" />
              <span className="text-xs">{label}</span>
            </button>
          ))}
        </div>
      </nav>

      {/* Modals and Popups */}
      <BottomSheet />
      <MissionsModal />
      <XPPopup />

      <style jsx>{`
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
        .active\\:scale-98:active {
          transform: scale(0.98);
        }
      `}</style>
    </div>
  );
};

export default FanZapMobile;
